<!DOCTYPE html>
<html lang="en">
<head>
  <title>How to X</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">

  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

  <style>
     body {
       font-family: Roboto, sans-serif, arial;
       margin: 0;
     }

     #titlebar {
       background-color: #d6ebff;
       border-bottom: 1px solid #add6ff;
       color: #333;
       font-size: 20px;
       min-height: 24px;
       padding: 12px 51px 12px 18px;
       position: relative;
     }
     #back {
       display: none;
       fill: #333;
       margin-left: -18px;
       position: absolute;
       top: 0;
     }
     svg {
       padding: 13px;
     }
     #title {
       display: block;
     }
     #view, #view-close {
       display: none;
       position: absolute;
       right: 16px;
       top: 0;
       fill: #333;
       margin-right: -16px;
     }
     #add {
       background-color: #d6ebff;
       border-radius: 32px;
       border: 1px solid #add6ff;
       color: #333;
       font-size: 20px;
       margin: 12px;
       padding: 10px 16px;
       position: absolute;
       right: 0;
     }

     #list {
       list-style-type: none;
       margin: 0;
       padding: 0;
     }
     #list li {
       background: white;
       border: none;
       box-shadow: 0 1px 2px 1px #ccc;
       font-size: 18px;
       min-height: 48px;
       padding: 2px 8px 2px 37px;
       position: relative;
     }
     #list .drag-icon {
       position: absolute;
       top: 0;
       left: 0;
     }
     #list .edit-icon {
       position: absolute;
       top: 0;
       right: 0;
     }
     #list .item {
       display: block;
       padding: 13px;
       margin-right: 34px;
     }
     #list input {
       font-family: Roboto, sans-serif, arial;
       padding: 8px;
       width: 100%;
       margin: -9px -9px;
       font-size: 18px;
       min-height: 20px;
     }
     #list input:focus {
       box-shadow: inset 0 0 4px 1px #add6ff;
       border: 1px solid #9dc6ef;
       outline: none;
       color: #2471bf;
     }

     #panel {
       display: none;
       position: absolute;;
       top: 49px;
       left: 100%;
       height: calc(100% - 49px);
       width: 100%;
       z-index: 10000;
       box-shadow: inset 0 0 10px 0px #add6ff;
       background: white;
     }
  </style>

  <script>
    var root = "How to X";

    // BOOTSTRAP
    // TO RE-BOOTSTRAP, RUN "delete localStorage.h2xTree" on the console.
    var tree = [
      ['Financial Aid', [
        ['Pay for college', [
          ['Calculate college cost', [
            'Estimate tuition',
            'Housing cost',
            'Books cost',
            'Cost of living',
          ]],
          'Apply for FAFSA',
          'Get scholarships',
          'Get student loans',
        ]],
        'Obtain transfer of financial aid funds',
        'Retain qualification for student loans',
        'Refinance student loans',
        'Manage student debt',
        'Get student loan forgiveness',
      ]],
      ['Civic services', [
        'Get unemployment benefits',
      ]],
      ['Miscellaneous', [
        'Play chess',
        'Water plants',
        'Draw a dragon',
      ]],
    ];
    // Replace "string" by ["string", []]
    function decompressTree(tree) {
      for (var i in tree) {
        if (typeof(tree[i]) == "string") {
          tree[i] = [tree[i], []];
        } else if (typeof(tree[i]) == "object" && tree[i][1] != null) {
          decompressTree(tree[i][1]);
        }
      }
    }
    decompressTree(tree);
    // END BOOTSTRAP.

    // Persist.
    if (typeof(Storage) == "function") {
      if (localStorage.h2xTree == null) {
        localStorage.h2xTree = JSON.stringify(tree);
      } else {
        tree = JSON.parse(localStorage.h2xTree);
        function compress(tree) {
          return tree.map(x => x[1].length > 0 ? [x[0], compress(x[1])] : x[0]);
        }
        console.log(JSON.stringify(compress(tree), null, 2));
      }
    }

    $(document).ready(function() {
      $(window).on('hashchange', function() { location.reload(); });

      // Where are we?
      var qidx = location.href.indexOf('#');
      var query = '';
      var qstr = location.href.substr(qidx+1);
      var is_view = qstr.endsWith('#VIEW');
      if (qidx != -1) query = unescape(qstr.replace(/#VIEW$/,'')) + '/';

      var node = root;
      var children = tree;
      while (true) {
        var idx = query.indexOf('/');
        if (idx == -1) break;
        node = query.substr(0, idx);
        var found = false;
        for (var i in children) {
          if (children[i][0] == node) {
            children = children[i][1];
            query = query.substr(idx + 1);
            found = true;
            break;
          }
        }
        if (!found) break;  // Url malformed, break infinite loop.
      }

      // Title.
      if (node != root) {
        $('#back').show();
        $('#view').show();
        $('#title').css('margin-left', '34px');
      }
      $('#title').text(node);
      $("#titlebar").disableSelection();

      // Back.
      $("#back").click(function() { history.back(); });
      $("#view-close").click(function() { history.back(); });

      // View.
      function viewFn() {
        window.location.hash += '#VIEW';
      }
      $("#view").click(function() { viewFn(); });

      // In view mode.
      if (is_view) {
        $('#panel').show().animate({left: 0}, 200);

        /*
        GET https://www.googleapis.com/customsearch/v1?key=INSERT_YOUR_API_KEY&cx=017576662512468239146:omuauf_lfve&q=lectures
          function hndlr(response) {
            for (var i = 0; i < response.items.length; i++) {
              var item = response.items[i];
              // in production code, item.htmlTitle should have the HTML entities escaped.
              document.getElementById("content").innerHTML += "<br>" + item.htmlTitle;
            }
          }
        script src="https://www.googleapis.com/customsearch/v1?key=YOUR-KEY&cx=017576662512468239146:omuauf_lfve&q=cars&callback=hndlr"
        */

        /*
        $.ajax({
            url: "http://www.google.com/search?q=foo",
            dataType: "jsonp",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            jsonpCallback: 'processJSONPResponse', // add this property

            success: function (result, status, xhr) {
                alert(result);
            },
            error: function (xhr, status, error) {
                alert("Error")
            }
        });
        */

        $('#view').hide();
        $('#view-close').show();
        return;
      }

      // List.
      function visitFn() {
        window.location.hash += (window.location.hash == '' ? '' : '/') + $(this).text();
      }

      var dragSVG = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#555"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/><path d="M0 0h24v24H0V0z" fill="none"/></svg>';
      var editSVG = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#555"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/><path d="M0 0h24v24H0z" fill="none"/></svg>';

      function addItem(node, children) {
        var editElement;
        $('#list').append(
          $('<li/>', { "class": "row ui-state-default ui-sortable-handle" }).append(
            $('<span/>', { "class": "drag-icon" }).append(dragSVG),
            $('<span/>', { "class": "item" })
              .text(node)
              .data('children', children)
              .click(visitFn),
            editElement = $('<span/>', { "class": "edit-icon" }).append(editSVG).click(editFn)));
        return editElement;
      }
      for (var i in children) {
        addItem(children[i][0], children[i][1]);
      }

      function updateFn() {
        children.splice(0, children.length);
        $('#list').children().each(function(i, li) {
          var item = $(li).find(".item");
          children.push([item.text(), item.data('children') || []]);
        });
        // Persist.
        if (typeof(Storage) == "function") {
          localStorage.h2xTree = JSON.stringify(tree);
        }
      }

      $("#list").sortable({ handle: '.drag-icon' }).on("sortupdate", updateFn);
      document.getSelection().removeAllRanges();
      $("#list").disableSelection();

      // List editing.
      function editFn() {
        var item = $(this).parent().find('.item');
        var text = item.text();
        item.html('');
        item.val(text);
        $("#list").enableSelection();

        function blurFn(e, p) {
          var me = $(this).parent().find('input').remove().end();
          var newVal = $(this).val().trim();
          // TODO(sitaram): drop slashes and hashes.
          me.text(p == "escape" ? me.val() : newVal);
          // If value is empty then delete the item.
          if (me.text() == "") me.parent().remove();
          if (p != "escape") updateFn();
          document.getSelection().removeAllRanges();
          $("#list").disableSelection();
        };

        function keyUpFn(e) {
          if (e.keyCode == 13) $(this).trigger("blur");
          else if (e.keyCode == 27) $(this).trigger("blur", "escape");
        }

        $('<input/>')
          .blur(blurFn)
          .bind("keyup", keyUpFn)
          .appendTo(item)
          .focus()
          .val(text)
          .scrollLeft(10000);
      }

      // Add.
      $("#add").click(function() { addItem("").trigger("click"); });

      /*
        // delete (trash icon)
        // label vs. query
        // ... persist on cloud
        // ... cross-reviews
        // ... v2: forks, steps vs. options, taking user input
        // DO THIS COLLABORATIVELY
      */
    });
  </script>
</head>
<body>

<div id="titlebar">
  <span id="back">
    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px">
      <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg></span>
  <span id="title">How to X</span>
  <span id="view">
    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px">
      <path d="M6 2c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6H6zm12 15.59l-2.2-2.2c.44-.69.7-1.51.7-2.39 0-2.48-2.02-4.5-4.5-4.5S7.5 10.52 7.5 13s2.02 4.5 4.5 4.5c.88 0 1.69-.26 2.39-.7l3.2 3.2H6V4h7.17L18 8.83v8.76zm-6-2.09c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/><path d="M0 0h24v24H0V0z" fill="none"/></svg></span>
  <span id="view-close">
    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px">
      <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/><path d="M0 0h24v24H0V0z" fill="none"/></svg></span>
</div>

<ul id="list" class="ui-sortable"></ul>

<div id="add">+</div>

<div id="panel"></div>

</body>
</html>
