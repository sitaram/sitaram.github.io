<!DOCTYPE html>
<html lang="en">
<head>
  <title>How to X</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">

  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

  <style>
     body {
       font-family: Roboto, sans-serif, arial;
       margin: 0;
     }

     #titlebar {
       padding: 16px 24px;
       border-bottom: 1px solid #add6ff;
       background-color: #d6ebff;
       position: relative;
       font-size: 20px;
       color: #333;
     }
     #back {
       display: none;
       position: absolute;
       top: 32%;
       fill: #333;
       margin: -3px 0 0 -8px;
     }
     #title {
       display: inline-block;
     }
     #view {
       position: absolute;
       right: 16px;
       top: 32%;
       font-style: italic;
     }
     #add {
       background-color: #d6ebff;
       border-radius: 32px;
       border: 1px solid #add6ff;
       color: #333;
       font-size: 20px;
       margin: 12px;
       padding: 8px 16px;
       position: absolute;
       right: 0;
     }

     #list {
       list-style-type: none;
       margin: 0;
       padding: 0;
     }
     #list li {
       background: white;
       border: none;
       box-shadow: 0 1px 2px 1px #ccc;
       font-size: 18px;
       min-height: 47px;
       padding: 4px 8px 4px 32px;
       position: relative;
     }
     #list .grip-icon {
       left: 12px;
       position: absolute;
       top: 20px;
       border: 3px solid rgba(0,0,0,0);
       transform: scale(2, 2);
     }
     #list .edit-icon {
       border: 16px solid white;
       position: absolute;
       top: 7px;
       right: 0px;
     }
     #list .item {
       display: block;
       padding: 13px;
       margin-right: 34px;
     }
     #list .input {
       font-family: Roboto, sans-serif, arial;
       padding: 4px;
       width: 100%;
       margin: -10px -6px;
       font-size: 18px;
       height: 20px;
     }
  </style>

  <script>
    var root = "How to X";
    var tree = {
      'Financial Aid': {
        'How to compute cost': {
          'How to estimate tuition': null,
          'Cost of housing': null,
          'Cost of books': null,
          'Cost of living': null,
        },
        'How to get scholarships': null,
        'How to apply for fafsa': null,
        'How to obtain transfer of financial aid funds': null,
        'How to get student loan': null,
        'How to retain qualification for student loan': null,
        'How to refinance student loan': null,
        'How to manage student debt': null,
        'How to refinance student loan': null,
        'How to get student loan forgiveness': null,
      },
      'Civic services': {
        'How to get unemployment benefits': null,
      },
      Miscellaneous: {
        'How to play chess': null,
        'How to water plants': null,
        'How to draw something': null,
      },
    };

    $(document).ready(function() {

      var qidx = location.href.indexOf('?');
      var query = '';
      if (qidx != -1) query = unescape(location.href.substr(qidx+1)) + '/';

      var node = root;
      var children = tree;
      while (true) {
        var idx = query.indexOf('/');
        if (idx == -1) break;
        node = query.substr(0, idx);
        children = children[node];
        query = query.substr(idx + 1);
      }
      console.log(node, children);

      if (node != root) {
        $('#back').show();
        $('#title').css('margin-left', '24px');
      }
      $('#title').text(node);

      function visitFn(e) {
        var node = e.data;
        if (location.href.indexOf('?') == -1) location.href += '?' + node;
        else location.href += '/' + node;
      }

      for (var child in children) {
        // document.write('<div class="item" onClick="visit(\'' + child + '\')">' + child + '</div>');

        $('#list').append(
          $('<li/>', { "class": "row ui-state-default ui-sortable-handle" }).append(
            $('<span/>', { "class": "grip-icon ui-icon ui-icon-grip-dotted-vertical" }),
            $('<span/>', { "class": "item" }).click(child, visitFn).append(child),
            $('<span/>', { "class": "edit-icon ui-icon ui-icon-pencil" })));
      }

      function addFn() {
      console.log("add");
      /*
        children['new'] = null;
        // TODO add a dom entry

        // delete (trash icon)
        // label vs. query
        // recursively edit subtopic
        // ... persist for the user, cross-reviews, etc.
        // ... v2: forks, steps vs. options, taking user input
        // DO THIS COLLABORATIVELY
      */
      }


      $("#list").sortable({ handle: '.grip-icon' });
      document.getSelection().removeAllRanges();
      $("#list").disableSelection();

      var editFn = function() {
        var item = $(this).parent().find('.item');
        // item.off("click");
        var text = item.text();
        item.html('');
        item.val(text);
        $("#list").enableSelection();

        var blurFn = function(e, p) {
          var me = $(this).parent().find('input').remove().end();
          me.text(p == "escape" ? me.val() : $(this).val());
          // item.click(editFn);
          document.getSelection().removeAllRanges();
          $("#list").disableSelection();
        };

        var keyUpFn = function(e) {
          if (e.keyCode == 13) $(this).trigger("blur");
          else if (e.keyCode == 27) $(this).trigger("blur", "escape");
        }

        $('<input/>')
          .addClass('input')
          .blur(blurFn)
          .bind("keyup", keyUpFn)
          .appendTo(item)
          .focus()
          .val(text);
      }
      $("#list .edit-icon").click(editFn);

      $("#add").click(addFn);
    });
  </script>
</head>
<body>

<div id="titlebar">
  <span id="back" onClick="history.back()">
    <svg focusable="false" xmlns="http://www.w3.org/2000/svg"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
  </span>
  <span id="title">How to X</span>
  <span id="view">view</span>
</div>

<ul id="list" class="ui-sortable"></ul>

<div id="add">+</div>

</body>
</html>
